{
    "name": "Cloud/Local Hybrid Transcription",
    "description": "Add cloud transcription support (Groq/LPU primary) with seamless toggle to local (WhisperKit) backup.",
    "branch": "feature/cloud-hybrid",
    "estimated_hours": 8,
    "tasks": [
        {
            "id": 1,
            "title": "Define Core Types & Protocol",
            "status": "pending",
            "description": "Foundation types for the hybrid architecture",
            "file": "Sources/GhostType/Services/TranscriptionProvider.swift",
            "details": [
                "Define `TranscriptionProvider` protocol (Sendable)",
                "Define `TranscriptionProviderState` enum (notReady, warmingUp, ready, error)",
                "Define `TranscriptionMode` enum (cloud, local)",
                "Define `TranscriptionError` enum (authenticationMissing, networkError, serverError, modelLoadFailed, encodingFailed)",
                "Define `OpenAIResponse` struct (Decodable for API JSON)"
            ]
        },
        {
            "id": 2,
            "title": "Implement Audio Utilities",
            "status": "pending",
            "description": "Audio encoding and analysis for cloud + VAD",
            "file": "Sources/GhostType/Services/Audio/AudioUtils.swift",
            "details": [
                "Implement `AudioEncoder.encodeToWAV(buffer:)` with RIFF header synthesis",
                "Implement `AudioAnalyzer.isSilence(_:)` using vDSP_rmsqv",
                "Add `Numeric.data` extension for little-endian byte conversion",
                "Add `AVAudioPCMBuffer.toFloatArray()` extension for WhisperKit compatibility"
            ],
            "unit_tests": [
                "Test WAV header is valid 44 bytes",
                "Test output is 16kHz Int16 mono",
                "Test silence detection threshold"
            ]
        },
        {
            "id": 3,
            "title": "Implement MultipartFormData",
            "status": "pending",
            "description": "HTTP body builder for file uploads",
            "file": "Sources/GhostType/Services/Cloud/MultipartFormData.swift",
            "details": [
                "Implement `addTextField(named:value:)`",
                "Implement `addDataField(named:filename:contentType:data:)`",
                "Implement `bodyData` computed property with boundary termination"
            ]
        },
        {
            "id": 4,
            "title": "Implement CloudTranscriptionService",
            "status": "pending",
            "description": "Groq LPU cloud transcription actor",
            "file": "Sources/GhostType/Services/Cloud/CloudTranscriptionService.swift",
            "details": [
                "Implement as `actor` conforming to `TranscriptionProvider`",
                "Use `AudioEncoder` to convert buffer to WAV",
                "Use `MultipartFormData` for request body",
                "Target: `https://api.groq.com/openai/v1/audio/transcriptions`",
                "Model: `whisper-large-v3`",
                "Parse `OpenAIResponse` JSON"
            ],
            "note": "OpenAI-compatible API allows future swap to OpenAI by changing URL only"
        },
        {
            "id": 5,
            "title": "Implement KeychainManager",
            "status": "pending",
            "description": "Secure API key storage",
            "file": "Sources/GhostType/Services/Security/KeychainManager.swift",
            "details": [
                "Service: `com.ghosttype.apikey`, Account: `groq`",
                "`saveKey(_:)` using SecItemAdd/SecItemUpdate",
                "`retrieveKey()` using SecItemCopyMatching",
                "`deleteKey()` for cleanup"
            ]
        },
        {
            "id": 6,
            "title": "Implement LocalTranscriptionService",
            "status": "pending",
            "description": "WhisperKit wrapper with VAD gating",
            "file": "Sources/GhostType/Services/Local/LocalTranscriptionService.swift",
            "details": [
                "Implement as `actor` conforming to `TranscriptionProvider`",
                "Wrap existing `WhisperKitService` or create fresh",
                "Call `AudioAnalyzer.isSilence()` BEFORE inference (hallucination fix)",
                "Implement `warmUp()` to load model",
                "Implement `cooldown()` to unload model (RAM savings)"
            ]
        },
        {
            "id": 7,
            "title": "Implement TranscriptionManager",
            "status": "pending",
            "description": "Orchestration layer with fallback logic",
            "file": "Sources/GhostType/Services/TranscriptionManager.swift",
            "details": [
                "`@MainActor class` with `ObservableObject`",
                "`@Published currentMode: TranscriptionMode`",
                "`@Published isTranscribing: Bool` (reentrancy guard)",
                "`transcribe(buffer:)` tries primary, falls back on error",
                "Integrate `KeychainManager` for API key",
                "Default to `.local` if no API key present"
            ]
        },
        {
            "id": 8,
            "title": "Bridge RingBuffer to AVAudioPCMBuffer",
            "status": "pending",
            "description": "Convert [Float] snapshot to AVAudioPCMBuffer",
            "file": "Sources/GhostType/Services/Audio/AudioBufferBridge.swift",
            "details": [
                "Create `AVAudioPCMBuffer` from `[Float]` array",
                "Ensure format matches: 16kHz, Float32, 1 channel",
                "Handle empty/short array edge cases"
            ],
            "uncertainty": "HIGH - Need to verify memory layout compatibility"
        },
        {
            "id": 9,
            "title": "Refactor DictationEngine",
            "status": "pending",
            "description": "Replace direct service calls with TranscriptionManager",
            "file": "Sources/GhostType/Services/DictationEngine.swift",
            "details": [
                "Remove `whisperKitService` and `mlxService` properties",
                "Inject `TranscriptionManager` instead",
                "Update `processOnePass()` to use bridge + manager",
                "Remove `useMLX` flag (now handled by manager)"
            ]
        },
        {
            "id": 10,
            "title": "Implement UI (Settings & Toggle)",
            "status": "pending",
            "description": "Menu bar settings view",
            "file": "Sources/GhostType/Views/MenuBarSettings.swift",
            "details": [
                "Segmented picker: Cloud (☁️) / Local (⚡)",
                "SecureField for API key (shown only in Cloud mode)",
                "Caption: 'API Key stored securely in Keychain'",
                "Status indicator for current mode"
            ]
        },
        {
            "id": 11,
            "title": "Update GhostTypeApp",
            "status": "pending",
            "description": "Wire up TranscriptionManager and new UI",
            "file": "Sources/GhostType/GhostTypeApp.swift",
            "details": [
                "Initialize `TranscriptionManager` in AppDelegate",
                "Pass manager to `MenuBarSettings` view",
                "Add menu item or popover for settings access"
            ]
        },
        {
            "id": 12,
            "title": "End-to-End Testing",
            "status": "pending",
            "description": "Validate full flow",
            "details": [
                "Test Cloud mode with valid Groq API key",
                "Test Local mode fallback",
                "Test mode toggle mid-session",
                "Test network failure -> auto fallback",
                "Test silence -> fast return (no API call)"
            ]
        }
    ],
    "architecture_decision": {
        "primary_provider": "Groq (LPU)",
        "reason": "Lowest latency (<500ms), OpenAI-compatible API",
        "format": "WAV (Int16, 16kHz, mono)",
        "fallback_provider": "Local (WhisperKit)",
        "optional_cloud_backup": "OpenAI (same API, change URL only)"
    },
    "uncertainty_areas": [
        {
            "area": "RingBuffer → AVAudioPCMBuffer Bridge",
            "concern": "Current DictationEngine uses [Float] arrays. Protocol expects AVAudioPCMBuffer. Need efficient memory-safe conversion.",
            "risk": "Medium"
        },
        {
            "area": "Long Audio Chunking (>30s)",
            "concern": "Report assumes short bursts. What if user dictates for 2+ minutes? Should we chunk and concatenate?",
            "risk": "Medium"
        },
        {
            "area": "Network Retry Strategy",
            "concern": "Report shows basic error handling. No exponential backoff or circuit breaker for rate limits.",
            "risk": "Low"
        },
        {
            "area": "cooldown() Trigger Timing",
            "concern": "When to unload local model? After inactivity timeout? On mode switch? Memory vs latency tradeoff.",
            "risk": "Low"
        },
        {
            "area": "Actor Reentrancy Pattern",
            "concern": "Report uses `isTranscribing` flag. Swift actors handle reentrancy differently. Is flag correct pattern?",
            "risk": "Low"
        }
    ]
}